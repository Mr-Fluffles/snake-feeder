<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Danger Noodle Tracker</title>
    <style>
        :root {
            --bg: #C8E6C9;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --accent: #00e676;
            --danger: #ff5252;
            --battle-bg: #2d3436;
            --map-bg: #4a3f35;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
            transition: background 0.5s ease;
            overflow-y: auto; 
            touch-action: manipulation; 
            padding-bottom: 50px;
        }

        /* HOLOGRAPHIC THEME */
        body.holo-theme {
            background: linear-gradient(270deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
            background-size: 800% 800%;
            animation: holoGradient 10s ease infinite;
        }
        @keyframes holoGradient {
            0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
        }

        /* WINTER THEME (The New Unlock) */
        body.winter-theme {
            background: linear-gradient(to bottom, #e0f7fa, #ffffff);
            --card: rgba(255, 255, 255, 0.9);
            --text: #2c3e50;
            --accent: #00bcd4;
        }
        
        /* SNOW ANIMATION */
        .snowflake {
            position: fixed; top: -10px; z-index: 9999;
            color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.3);
            user-select: none; pointer-events: none;
            animation: fall linear forwards;
        }
        @keyframes fall { to { transform: translateY(110vh); } }

        .container {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 20px;
            width: 75%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            z-index: 10;
            margin-top: 20px;
            transition: background 0.5s, color 0.5s;
        }
        h1 { margin-top: 0; font-size: 1.6rem; }
        .emoji { font-size: 3rem; display: block; margin-bottom: 10px; transition: filter 0.5s; }
        
        /* GIFT BOX OVERLAY */
        .gift-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .gift-box {
            font-size: 8rem; cursor: pointer; transition: transform 0.1s; user-select: none;
        }
        .gift-box:active { transform: scale(0.9); }
        .gift-text { color: white; font-weight: bold; margin-top: 20px; font-size: 1.5rem; }
        .gift-progress { color: #00e676; margin-top: 10px; font-family: monospace; }
        
        .gift-card-reveal {
            background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px;
            text-align: center; display: none; box-shadow: 0 0 50px #fff;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #333;
        }
        .fine-print {
            font-size: 0.6rem; color: #777; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; line-height: 1.2;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* RPG & MAP STYLES */
        .stage-1 { filter: none; }
        .stage-2 { filter: hue-rotate(180deg) saturate(1.5); }
        .stage-3 { filter: invert(1) drop-shadow(0 0 5px #ff0000); }
        .map-screen, .battle-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 90; flex-direction: column; padding: 20px; box-sizing: border-box;
        }
        .map-screen { background: var(--map-bg); }
        .battle-screen { background: var(--battle-bg); z-index: 100; }
        .map-header, .battle-hud, .battle-controls {
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 10px;
            margin-bottom: 10px; text-align: left; color: #333;
        }
        .map-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex-grow: 1; align-content: center; }
        .loc-btn {
            background: #fff; border: 3px solid #badc58; padding: 15px; border-radius: 12px;
            color: #333; font-weight: bold; font-size: 0.9rem; cursor: pointer;
        }
        .hp-bar-bg { width: 100%; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .hp-bar-fill { height: 100%; background: #00e676; width: 100%; transition: width 0.3s; }
        .hp-bar-fill.low { background: #ff5252; }
        .arena { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .sprite { font-size: 5rem; transition: transform 0.2s; }
        .move-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .move-btn { background: #eee; border: 2px solid #333; padding: 15px; border-radius: 10px; font-weight: bold; }
        .log { font-family: monospace; font-size: 0.9rem; height: 30px; margin-bottom: 10px; font-weight: bold; color: #d63031; }
        .shake { animation: shake 0.4s; }
        .lunge { animation: lunge 0.3s; }
        @keyframes shake { 0% {transform: translateX(0);} 25% {transform: translateX(-10px);} 75% {transform: translateX(10px);} 100% {transform: translateX(0);} }
        @keyframes lunge { 0% {transform: scale(1);} 50% {transform: scale(1.4);} 100% {transform: scale(1);} }

        /* UI BUTTONS */
        .status { font-size: 1.4rem; margin: 20px 0; padding: 15px; background: #fff; border-radius: 10px; font-weight: bold; border: 2px solid #eee; color: #333; }
        .feed-btn { background: var(--accent); color: #000; border: none; padding: 15px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; width: 100%; margin-top: 10px; }
        .rpg-btn { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; border: none; padding: 12px; border-radius: 50px; font-weight: bold; width: 100%; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.4); cursor: pointer; }
        .settings-toggle { background: none; border: none; color: #666; font-size: 1.5rem; margin-top: 20px; cursor: pointer; opacity: 0.7; }
        .settings-panel { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .input-group { margin: 15px 0; font-size: 1rem; color: #888; }
        input { background: #eee; border: none; padding: 5px; border-radius: 5px; }
        .secondary { background: transparent; border: 2px solid var(--accent); color: var(--accent); margin-top: 20px; border-radius: 50px; padding: 10px 20px; font-weight: bold; cursor: pointer; width: 100%; }
        .small-text { font-size: 0.8rem; color: #888; margin-top: 10px;}

        /* SWATCHES */
        .theme-label { margin-top: 20px; font-size: 0.9rem; color: #888; display: block; }
        .pastel-swatches { display: flex; justify-content: center; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .manual-picker-wrapper { display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.8rem; color: #666; }
        input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; border-radius: 50%; }
    </style>
</head>
<body>

<div class="gift-overlay" id="giftOverlay">
    <div id="wrapperBox">
        <div class="gift-text">MERRY CHRISTMAS!</div>
        <div class="gift-box" onclick="tapGift()">üéÅ</div>
        <div class="gift-progress">Taps Remaining: <span id="tapCount">100</span></div>
        <div style="color:#aaa; font-size:0.8rem; margin-top:5px;">(Tap fast to unwrap!)</div>
    </div>
    
    <div class="gift-card-reveal" id="giftCard">
        <h2 style="color:#eb4d4b;">üéÑ Merry Christmas! üéÑ</h2>
        <p style="font-size:1.1rem; color:#333; margin: 20px 0; font-weight: bold;">
            You have one free 3D print of your choosing!
            <br><span style="font-size:0.9rem; font-weight:normal;">(I just have to be capable of making it if I need to design it)</span>
        </p>
        <div class="fine-print">
            *fine print: cannot be gifted to anyone else and this coupon is onetime use and depending on size might have to be brought back in person so shipping times may vary.
        </div>
        <br>
        <p style="color:#00bcd4; font-weight:bold;">‚ùÑÔ∏è UNLOCKED: WINTER THEME ‚ùÑÔ∏è</p>
        <button class="feed-btn" onclick="closeGift()">Awesome, thanks!</button>
    </div>
</div>

<div class="map-screen" id="mapScreen">
    <div class="map-header">
        <h2 style="margin:0;">‚ùÑÔ∏è The Frozen House</h2>
        <p id="mapLog" style="color:#666; font-size:0.9rem; margin-top:5px;">Brrr! It's cold.</p>
    </div>
    <div class="battle-hud">
        <div style="display:flex; justify-content:space-between;">
            <b id="mapPlayerName">Noodle</b> <span>Lvl <span id="mapPlayerLvl">1</span></span>
        </div>
        <div class="hp-bar-bg"><div class="hp-bar-fill" id="mapPlayerHp"></div></div>
    </div>
    <div class="map-grid">
        <button class="loc-btn" onclick="travelTo('livingroom')"><span>üõãÔ∏è</span>Fireplace<br><small>(Warm Up & Heal)</small></button>
        <button class="loc-btn" onclick="travelTo('kitchen')"><span>üç™</span>Kitchen<br><small>(Enemies: Cookies)</small></button>
        <button class="loc-btn" onclick="travelTo('basement')"><span>üéÅ</span>Basement<br><small>(Enemies: Coal)</small></button>
        <button class="loc-btn" onclick="travelTo('garage')"><span>üõ∑</span>Garage<br><small>(Enemies: Reindeer)</small></button>
        <button class="loc-btn" id="bossLocBtn" onclick="travelTo('hallway')" style="grid-column: span 2; opacity: 0.5; pointer-events: none;">
            <span>‚òÉÔ∏è</span>The North Pole<br><small>(BOSS)</small>
        </button>
    </div>
    <button class="secondary" onclick="exitRPG()" style="margin-top:20px;">Exit to App</button>
</div>

<div class="battle-screen" id="battleScreen">
    <div class="battle-hud">
        <div style="display:flex; justify-content:space-between;">
            <b id="enemyName">Gingerbread Man</b> <span>Lvl <span id="enemyLvl">1</span></span>
        </div>
        <div class="hp-bar-bg"><div class="hp-bar-fill" id="enemyHp"></div></div>
    </div>
    <div class="arena">
        <div class="sprite" id="enemySprite">üç™</div>
        <div style="height: 60px;"></div>
        <div class="sprite stage-1" id="playerSprite">üêçüéÖ</div>
    </div>
    <div class="battle-controls">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <b id="playerName">Shoelace</b> <span>Lvl <span id="playerLvl">1</span></span>
        </div>
        <div class="hp-bar-bg" style="margin-bottom:10px;"><div class="hp-bar-fill" id="playerHp"></div></div>
        <div class="log" id="battleLog">Merry Crisis!</div>
        <div class="move-grid" id="moveGrid"></div>
        <button class="move-btn" id="continueBtn" style="width:100%; display:none; margin-top:10px;" onclick="returnToMap()">Continue</button>
    </div>
</div>

<div class="container" id="mainCard">
    <span class="emoji" id="mascot">üêçüéÖ</span>
    <h1 id="titleText">Danger Noodle Tracker</h1>
    
    <button class="rpg-btn" onclick="startRPG()">‚öîÔ∏è Play Christmas RPG</button>
    <div class="status" id="statusDisplay">Loading...</div>
    <button class="feed-btn" onclick="confirmFeed()">I Fed The Snek!</button>
    <p class="small-text" id="lastFedText"></p>
    <button class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="input-group">Feed every <input type="number" id="interval" value="21" onchange="saveSettings()"> days</div>
        <div class="input-group">At <input type="time" id="feedTime" value="09:00" onchange="saveSettings()"></div>
        <button class="secondary" onclick="addToCalendar()">üìÖ Update Calendar</button>
        <button class="secondary" onclick="resetGift()">üéÅ Re-Wrap Gift</button>

        <span class="theme-label">Theme:</span>
        <div class="pastel-swatches" id="swatchContainer">
            <div class="swatch" style="background: #C8E6C9;" onclick="setTheme('#C8E6C9')"></div>
            <div class="swatch" style="background: #E1BEE7;" onclick="setTheme('#E1BEE7')"></div>
            <div class="swatch" style="background: #B3E5FC;" onclick="setTheme('#B3E5FC')"></div>
            <div class="swatch" style="background: #FFCCBC;" onclick="setTheme('#FFCCBC')"></div>
        </div>
        <div class="manual-picker-wrapper">custom: <input type="color" id="bgPicker" value="#C8E6C9"></div>
    </div>
</div>

<script>
    // --- APP & RPG LOGIC ---
    const savedInterval = localStorage.getItem('interval');
    if (savedInterval) document.getElementById('interval').value = savedInterval;
    updateDisplay();

    let player = { lvl: 1, hp: 30, maxHp: 30, xp: 0, nextLvl: 50, stage: 1 };
    let enemy = {};
    if(localStorage.getItem('rpgSave')) player = JSON.parse(localStorage.getItem('rpgSave'));

    // --- THEME & UNLOCK LOGIC ---
    const savedColor = localStorage.getItem('themeColor');
    const goldUnlocked = localStorage.getItem('goldUnlocked');
    const holoUnlocked = localStorage.getItem('holoUnlocked');
    const winterUnlocked = localStorage.getItem('winterUnlocked');

    // Load initial theme
    const initialColor = savedColor || '#C8E6C9';
    if(initialColor === 'holo') { document.body.classList.add('holo-theme'); } 
    else if(initialColor === 'winter') { enableWinter(false); }
    else { setTheme(initialColor, false); }

    // Load Swatches
    if(goldUnlocked === 'true') addGoldSwatch();
    if(holoUnlocked === 'true') addHoloSwatch();
    if(winterUnlocked === 'true') addWinterSwatch();

    function setTheme(color, save = true) {
        document.body.classList.remove('holo-theme', 'winter-theme');
        document.documentElement.style.setProperty('--bg', color);
        document.getElementById('bgPicker').value = color;
        // Update button text color for readability if needed
        document.documentElement.style.setProperty('--text', '#e0e0e0');
        if (save) localStorage.setItem('themeColor', color);
        stopSnow();
    }
    function setHolo(save = true) {
        document.body.classList.remove('winter-theme');
        document.body.classList.add('holo-theme');
        if(save) localStorage.setItem('themeColor', 'holo');
        stopSnow();
    }
    function enableWinter(save = true) {
        document.body.classList.remove('holo-theme');
        document.body.classList.add('winter-theme');
        if(save) localStorage.setItem('themeColor', 'winter');
        startSnow();
    }

    // Swatch Generators
    function addGoldSwatch() {
        if(document.getElementById('goldSwatch')) return;
        const div = document.createElement('div'); div.id='goldSwatch'; div.className='swatch';
        div.style.background = 'linear-gradient(135deg, #FFD700, #FDB931)';
        div.onclick = function(){ setTheme('#FFD700'); };
        document.getElementById('swatchContainer').appendChild(div);
    }
    function addHoloSwatch() {
        if(document.getElementById('holoSwatch')) return;
        const div = document.createElement('div'); div.id='holoSwatch'; div.className='swatch';
        div.style.background = 'linear-gradient(135deg, #fbc2eb, #a6c1ee)';
        div.onclick = function(){ setHolo(); };
        document.getElementById('swatchContainer').appendChild(div);
    }
    function addWinterSwatch() {
        if(document.getElementById('winterSwatch')) return;
        const div = document.createElement('div'); div.id='winterSwatch'; div.className='swatch';
        div.style.background = 'linear-gradient(135deg, #e0f7fa, #00bcd4)';
        div.innerHTML = "‚ùÑÔ∏è"; div.style.display="flex"; div.style.alignItems="center"; div.style.justifyContent="center"; div.style.fontSize="12px";
        div.onclick = function(){ enableWinter(); };
        document.getElementById('swatchContainer').appendChild(div);
    }

    document.getElementById('bgPicker').addEventListener('input', function(e) { setTheme(e.target.value); });

    // --- SNOW LOGIC ---
    let snowInterval;
    function startSnow() {
        if(snowInterval) return; // Already snowing
        snowInterval = setInterval(() => {
            const flake = document.createElement('div');
            flake.innerText = ['‚ùÑÔ∏è', '‚ùÖ', '‚ùÜ'][Math.floor(Math.random()*3)];
            flake.className = 'snowflake';
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.opacity = Math.random();
            flake.style.fontSize = (Math.random() * 10 + 10) + 'px';
            flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
            document.body.appendChild(flake);
            setTimeout(() => flake.remove(), 5000);
        }, 300);
    }
    function stopSnow() {
        clearInterval(snowInterval);
        snowInterval = null;
        document.querySelectorAll('.snowflake').forEach(el => el.remove());
    }

    // --- GIFT LOGIC ---
    let taps = 100;
    const giftOpened = localStorage.getItem('xmasGiftOpened');

    if (giftOpened !== 'true') {
        document.getElementById('giftOverlay').style.display = 'flex';
        // Snow during gift opening regardless of theme
        startSnow();
    }

    function tapGift() {
        taps--;
        document.getElementById('tapCount').innerText = taps;
        const box = document.querySelector('.gift-box');
        box.style.transform = `scale(1.1) rotate(${Math.random()*20 - 10}deg)`;
        setTimeout(() => box.style.transform = 'scale(1) rotate(0deg)', 100);

        if (taps <= 0) {
            document.getElementById('wrapperBox').style.display = 'none';
            document.getElementById('giftCard').style.display = 'block';
            
            // UNLOCK REWARD
            localStorage.setItem('xmasGiftOpened', 'true');
            localStorage.setItem('winterUnlocked', 'true');
            addWinterSwatch();
            
            confettiExplosion();
        }
    }

    function closeGift() {
        document.getElementById('giftOverlay').style.display = 'none';
        // Switch to winter theme immediately upon close
        enableWinter();
    }

    function resetGift() {
        localStorage.removeItem('xmasGiftOpened');
        location.reload();
    }

    function confettiExplosion() {
        for(let i=0; i<50; i++) {
            const conf = document.createElement('div');
            conf.style.position = 'fixed';
            conf.style.left = '50%'; conf.style.top = '50%';
            conf.style.width = '10px'; conf.style.height = '10px';
            conf.style.backgroundColor = ['#badc58', '#ff7675', '#74b9ff'][Math.floor(Math.random()*3)];
            conf.style.zIndex = 300;
            document.body.appendChild(conf);
            const destX = (Math.random() - 0.5) * window.innerWidth;
            const destY = (Math.random() - 0.5) * window.innerHeight;
            conf.animate([
                { transform: 'translate(0,0)' },
                { transform: `translate(${destX}px, ${destY}px) rotate(720deg)`, opacity: 0 }
            ], { duration: 1000, fill: 'forwards' });
        }
    }

    // --- RPG & APP UTILS ---
    const MOVES = {
        1: [{name:"Boop", dmg:4, type:"atk"}, {name:"Hiss", dmg:0, type:"debuff", msg:"Enemy slowed!"}, {name:"Panic", dmg:0, type:"heal", val:10, msg:"Healed!"}, {name:"Nip", dmg:6, type:"atk"}],
        2: [{name:"Strike", dmg:12, type:"atk"}, {name:"Coil", dmg:0, type:"heal", val:20, msg:"Healed!"}, {name:"Tail Whip", dmg:18, type:"atk", acc:0.8}, {name:"Venom", dmg:5, type:"dot", msg:"Poisoned!"}],
        3: [{name:"Chomp", dmg:25, type:"atk"}, {name:"Constrict", dmg:10, type:"stun", msg:"Stunned!"}, {name:"Devour", dmg:20, type:"lifesteal", msg:"Drained!"}, {name:"Judgement", dmg:99, type:"ult", acc:0.5}]
    };

    function startRPG() {
        document.getElementById('mainCard').style.display = 'none';
        document.getElementById('mapScreen').style.display = 'flex';
        updateMapUI();
    }
    function exitRPG() {
        document.getElementById('mapScreen').style.display = 'none';
        document.getElementById('mainCard').style.display = 'block';
        localStorage.setItem('rpgSave', JSON.stringify(player));
    }
    function updateMapUI() {
        document.getElementById('mapPlayerName').innerText = ["Shoelace", "Danger Noodle", "Nope Rope"][player.stage - 1];
        document.getElementById('mapPlayerLvl').innerText = player.lvl;
        const pPct = (player.hp/player.maxHp)*100;
        document.getElementById('mapPlayerHp').style.width = pPct+"%";
        const bossBtn = document.getElementById('bossLocBtn');
        if(player.lvl >= 5) { bossBtn.style.opacity=1; bossBtn.style.pointerEvents='auto'; }
    }
    function travelTo(loc) {
        let chance = 0.5; let danger = 1;
        if(loc === 'livingroom') { 
            player.hp = Math.min(player.maxHp, player.hp + Math.floor(player.maxHp*0.3));
            document.getElementById('mapLog').innerText = "Warmed up by the fire. HP Restored.";
            updateMapUI(); localStorage.setItem('rpgSave', JSON.stringify(player)); return;
        }
        else if (loc === 'hallway') { danger = 99; chance = 1.0; } 
        else if (loc === 'garage') { danger = 3; chance = 0.7; }
        
        if(Math.random() < chance) { setTimeout(() => generateEnemy(danger), 400); }
        else { document.getElementById('mapLog').innerText = "Safe... for now."; }
    }
    function generateEnemy(danger) {
        document.getElementById('mapScreen').style.display = 'none';
        document.getElementById('battleScreen').style.display = 'flex';
        
        if(danger === 99) {
            enemy = { name: "THE GRINCH", icon: "üßü", hp: 200, maxHp: 200, atk: 25 };
        } else {
            const list = [
                {n:"Gingerbread Man", i:"üç™", hp:20, atk:4},
                {n:"Evil Elf", i:"üßù", hp:35, atk:6},
                {n:"Killer Reindeer", i:"ü¶å", hp:50, atk:10},
                {n:"Angry Snowman", i:"‚òÉÔ∏è", hp:80, atk:14}
            ];
            const base = list[Math.min(list.length-1, Math.floor(Math.random() * (player.lvl/2 + 1)))];
            enemy = { ...base, maxHp: base.hp+(player.lvl*5), hp: base.hp+(player.lvl*5), atk: base.atk+player.lvl };
        }
        
        document.getElementById('enemyName').innerText = enemy.name;
        document.getElementById('enemyLvl').innerText = player.lvl;
        document.getElementById('enemySprite').innerText = enemy.icon;
        document.getElementById('playerSprite').innerText = "üêçüéÖ";
        document.getElementById('battleLog').innerText = `A wild ${enemy.name} appeared!`;
        
        const grid = document.getElementById('moveGrid'); grid.innerHTML = "";
        MOVES[player.stage].forEach(m => {
            const btn = document.createElement('button'); btn.className='move-btn'; btn.innerText=m.name;
            btn.onclick = () => executeMove(m); grid.appendChild(btn);
        });
        const run = document.createElement('button'); run.className='move-btn run-btn'; run.innerText="RUN";
        run.onclick = returnToMap; grid.appendChild(run);
        
        document.getElementById('moveGrid').style.display = 'grid';
        document.getElementById('continueBtn').style.display = 'none';
        renderUI();
    }
    function executeMove(m) {
        let dmg = 0; let msg = "";
        if(m.type==='atk') { dmg=m.dmg+player.lvl; enemy.hp-=dmg; msg=`Hit for ${dmg}!`; }
        else if(m.type==='heal') { player.hp+=m.val; msg="Healed!"; }
        setTimeout(() => {
            if(enemy.hp <= 0) { victory(); }
            else { 
                player.hp -= enemy.atk; 
                document.getElementById('battleLog').innerText = `Enemy hit for ${enemy.atk}!`;
                renderUI();
                if(player.hp <= 0) {
                    player.hp = player.maxHp; player.xp = 0;
                    alert("You fainted! XP Lost."); returnToMap();
                }
            }
        }, 800);
        document.getElementById('battleLog').innerText = msg; renderUI();
    }
    function victory() {
        player.xp += 20;
        if(player.xp >= player.nextLvl) { player.lvl++; player.xp=0; player.nextLvl*=1.5; player.maxHp+=10; player.hp=player.maxHp; alert("Level Up!"); checkEvolution(); }
        document.getElementById('battleLog').innerText = "Victory!";
        document.getElementById('moveGrid').style.display='none';
        document.getElementById('continueBtn').style.display='block';
        localStorage.setItem('rpgSave', JSON.stringify(player));
    }
    function checkEvolution() {
        if(player.lvl >= 5 && player.stage < 2) { player.stage=2; alert("Evolved to Danger Noodle!"); }
        if(player.lvl >= 10 && player.stage < 3) { player.stage=3; alert("Evolved to Nope Rope!"); }
    }
    function renderUI() {
        document.getElementById('enemyHp').style.width = Math.max(0, (enemy.hp/enemy.maxHp)*100) + "%";
        document.getElementById('playerHp').style.width = Math.max(0, (player.hp/player.maxHp)*100) + "%";
        document.getElementById('playerLvl').innerText = player.lvl;
    }
    function returnToMap() {
        document.getElementById('battleScreen').style.display = 'none';
        document.getElementById('mapScreen').style.display = 'flex';
        updateMapUI();
    }
    function toggleSettings() {
        const p = document.getElementById('settingsPanel'); p.style.display = p.style.display==='block'?'none':'block';
    }
    function saveSettings() { localStorage.setItem('interval', document.getElementById('interval').value); updateDisplay(); }
    function confirmFeed() { if(confirm("Confirm?")) feedSnake(); }
    function feedSnake() { localStorage.setItem('lastFed', new Date().toISOString()); updateDisplay(); }
    function updateDisplay() {
        const last = localStorage.getItem('lastFed'); const int = parseInt(document.getElementById('interval').value)||21;
        if(!last) return;
        const next = new Date(new Date(last)); next.setDate(next.getDate()+int);
        const diff = Math.ceil((next - new Date())/(1000*60*60*24));
        document.getElementById('lastFedText').innerText = "Last: "+new Date(last).toLocaleDateString();
        document.getElementById('statusDisplay').innerText = diff <= 0 ? "FEED NOW!" : `Next: ${diff} days`;
    }
    function addToCalendar() { alert("Calendar updated (Simulated)"); }
</script>
</body>
</html>
